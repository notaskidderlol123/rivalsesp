local camera = game.Workspace.CurrentCamera
local players = game:GetService("Players")
local localPlayer = players.LocalPlayer
local runService = game:GetService("RunService")

local function createESP(player)
    if player == localPlayer then return end
    
    local esp = {}

    -- Box ESP
    esp.box = Drawing.new("Square")
    esp.box.Color = Color3.fromRGB(255, 255, 255)
    esp.box.Thickness = 1
    esp.box.Filled = false
    esp.box.Visible = false
    
    -- Name
    esp.name = Drawing.new("Text")
    esp.name.Size = 18
    esp.name.Color = Color3.fromRGB(255, 255, 255)
    esp.name.Outline = true
    esp.name.Visible = false

    -- Distance
    esp.distance = Drawing.new("Text")
    esp.distance.Size = 16
    esp.distance.Color = Color3.fromRGB(255, 255, 255)
    esp.distance.Outline = true
    esp.distance.Visible = false

    -- Health bar
    esp.healthBar = Drawing.new("Line")
    esp.healthBar.Thickness = 3
    esp.healthBar.Visible = false

    -- Tracer line
    esp.tracer = Drawing.new("Line")
    esp.tracer.Color = Color3.fromRGB(0, 255, 0)
    esp.tracer.Thickness = 1
    esp.tracer.Visible = false

    -- Skeleton ESP
    local bones = {
        "Head", "UpperTorso", "LowerTorso",
        "LeftUpperArm", "LeftLowerArm", "LeftHand",
        "RightUpperArm", "RightLowerArm", "RightHand",
        "LeftUpperLeg", "LeftLowerLeg", "LeftFoot",
        "RightUpperLeg", "RightLowerLeg", "RightFoot"
    }

    esp.skeleton = {}
    for _, bone in pairs(bones) do
        local line = Drawing.new("Line")
        line.Color = Color3.fromRGB(255, 165, 0)
        line.Thickness = 2
        line.Visible = false
        esp.skeleton[bone] = line
    end

    -- Function to update ESP
    local function updateESP()
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local rootPart = player.Character.HumanoidRootPart
            local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
            local vector, onScreen = camera:WorldToViewportPoint(rootPart.Position)
            
            if onScreen then
                local head = player.Character:FindFirstChild("Head")
                local feet = player.Character:FindFirstChild("RightFoot") or player.Character:FindFirstChild("LeftFoot")
                
                if head and feet then
                    local headPos = camera:WorldToViewportPoint(head.Position + Vector3.new(0, 0.5, 0))
                    local feetPos = camera:WorldToViewportPoint(feet.Position - Vector3.new(0, 0.5, 0))

                    -- Calculate box size and position
                    local boxHeight = math.abs(headPos.Y - feetPos.Y)
                    local boxWidth = boxHeight * 0.6
                    local boxPosition = Vector2.new(vector.X - boxWidth / 2, feetPos.Y)

                    esp.box.Size = Vector2.new(boxWidth, boxHeight)
                    esp.box.Position = boxPosition
                    esp.box.Visible = true

                    -- Name
                    esp.name.Position = Vector2.new(vector.X, feetPos.Y - 20)
                    esp.name.Text = player.Name
                    esp.name.Visible = true

                    -- Distance
                    local playerDistance = (localPlayer.Character.HumanoidRootPart.Position - rootPart.Position).Magnitude
                    esp.distance.Position = Vector2.new(vector.X, feetPos.Y - 5)
                    esp.distance.Text = tostring(math.floor(playerDistance)) .. "m"
                    esp.distance.Visible = true

                    -- Health bar
                    if humanoid then
                        local healthPercent = humanoid.Health / humanoid.MaxHealth
                        esp.healthBar.From = Vector2.new(boxPosition.X - 6, boxPosition.Y + boxHeight)
                        esp.healthBar.To = Vector2.new(boxPosition.X - 6, boxPosition.Y + boxHeight * (1 - healthPercent))
                        esp.healthBar.Color = Color3.fromRGB(0, 255, 0)
                        esp.healthBar.Visible = true
                    end

                    -- Tracer line
                    esp.tracer.From = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y)
                    esp.tracer.To = Vector2.new(vector.X, vector.Y + 50)
                    esp.tracer.Visible = true
                end
            else
                esp.box.Visible = false
                esp.name.Visible = false
                esp.distance.Visible = false
                esp.healthBar.Visible = false
                esp.tracer.Visible = false
            end
        end
    end

    runService.RenderStepped:Connect(updateESP)
end

-- Apply ESP to all players
for _, player in pairs(players:GetPlayers()) do
    if player ~= localPlayer then
        createESP(player)
    end
end

players.PlayerAdded:Connect(function(player)
    wait(1)
    createESP(player)
end)
