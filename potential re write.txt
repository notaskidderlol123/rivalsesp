-- Advanced Roblox ESP (Box, Bone, Distance, Health Bar, Tracers)
local players = game:GetService("Players")
local runService = game:GetService("RunService")
local camera = game:GetService("Workspace").CurrentCamera
local localPlayer = players.LocalPlayer

local espFolder = Instance.new("Folder", game.CoreGui)
espFolder.Name = "ESP"

-- Function to create ESP for a player
function createESP(player)
    if player == localPlayer then return end
    local character = player.Character
    if not character then return end

    local espBox = Drawing.new("Square")
    espBox.Color = Color3.new(1, 0, 0)
    espBox.Thickness = 2
    espBox.Filled = false
    espBox.Visible = false

    local nameTag = Drawing.new("Text")
    nameTag.Size = 16
    nameTag.Color = Color3.new(1, 1, 1)
    nameTag.Center = true
    nameTag.Outline = true
    nameTag.Visible = false

    local distanceTag = Drawing.new("Text")
    distanceTag.Size = 14
    distanceTag.Color = Color3.new(1, 1, 1)
    distanceTag.Center = true
    distanceTag.Outline = true
    distanceTag.Visible = false

    local healthBar = Drawing.new("Line")
    healthBar.Thickness = 3
    healthBar.Visible = false

    local tracer = Drawing.new("Line")
    tracer.Thickness = 1.5
    tracer.Color = Color3.new(1, 1, 1)
    tracer.Visible = false

    local function updateESP()
        if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
            espBox.Visible = false
            nameTag.Visible = false
            distanceTag.Visible = false
            healthBar.Visible = false
            tracer.Visible = false
            return
        end

        local rootPart = player.Character:FindFirstChild("HumanoidRootPart")
        local head = player.Character:FindFirstChild("Head")
        local humanoid = player.Character:FindFirstChild("Humanoid")
        
        if not rootPart or not head or not humanoid then return end

        local screenPosition, onScreen = camera:WorldToViewportPoint(rootPart.Position)

        if onScreen then
            local headScreenPos = camera:WorldToViewportPoint(head.Position)
            local rootScreenPos = camera:WorldToViewportPoint(rootPart.Position)
            local sizeY = math.abs(headScreenPos.Y - rootScreenPos.Y) * 2
            local sizeX = sizeY / 2

            espBox.Size = Vector2.new(sizeX, sizeY)
            espBox.Position = Vector2.new(screenPosition.X - sizeX / 2, screenPosition.Y - sizeY / 2)
            espBox.Visible = true

            nameTag.Position = Vector2.new(screenPosition.X, screenPosition.Y - sizeY / 2 - 15)
            nameTag.Text = player.Name
            nameTag.Visible = true

            local distance = (localPlayer.Character.HumanoidRootPart.Position - rootPart.Position).Magnitude
            distanceTag.Position = Vector2.new(screenPosition.X, screenPosition.Y + sizeY / 2 + 5)
            distanceTag.Text = string.format("[%.0f Studs]", distance)
            distanceTag.Visible = true

            local healthPercent = humanoid.Health / humanoid.MaxHealth
            local barHeight = sizeY * healthPercent
            local barPosition = Vector2.new(screenPosition.X - sizeX / 2 - 6, screenPosition.Y - sizeY / 2 + (sizeY - barHeight))

            healthBar.From = Vector2.new(screenPosition.X - sizeX / 2 - 6, screenPosition.Y - sizeY / 2)
            healthBar.To = barPosition
            healthBar.Color = Color3.fromRGB(0, 255, 0)
            healthBar.Visible = true

            tracer.From = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y)
            tracer.To = Vector2.new(screenPosition.X, screenPosition.Y + sizeY / 2)
            tracer.Visible = true
        else
            espBox.Visible = false
            nameTag.Visible = false
            distanceTag.Visible = false
            healthBar.Visible = false
            tracer.Visible = false
        end
    end

    -- Bone ESP
    local function createBoneESP(character)
        local bones = {"Head", "Torso", "Left Arm", "Right Arm", "Left Leg", "Right Leg"}
        for i = 1, #bones do
            local part = character:FindFirstChild(bones[i])
            if part then
                local attachment = Instance.new("Attachment", part)
                local beam = Instance.new("Beam")
                beam.Parent = part
                beam.Attachment0 = attachment
                beam.Attachment1 = attachment
                beam.Color = ColorSequence.new(Color3.fromRGB(0, 255, 0))
                beam.FaceCamera = true
                beam.Width0 = 0.1
                beam.Width1 = 0.1
            end
        end
    end

    createBoneESP(character)

    runService.RenderStepped:Connect(updateESP)
end

-- Apply ESP to all players
for _, player in pairs(players:GetPlayers()) do
    if player.Character then
        createESP(player)
    end
end

-- Update ESP when new players join
players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function(character)
        createESP(player)
    end)
end)
